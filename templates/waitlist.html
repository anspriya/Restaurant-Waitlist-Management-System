<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Waitlist Status</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/waitliststyle.css') }}" />
</head>
<body>
    <div class="container">
        <h2>Thank You, <span id="customerName"></span>!</h2>
        <p>You are <strong><span id="queuePosition"></span></strong> in line</p>
        <div id="waitTimeDisplay">
            Estimated Wait Time: <span id="time"></span>
        </div>

        <svg class="circle" width="200" height="200">
            <circle cx="100" cy="100" r="90" stroke="#e6e6e6" stroke-width="10" fill="none"></circle>
            <circle id="progressCircle" cx="100" cy="100" r="90" stroke="#4caf50" stroke-width="10" fill="none" stroke-dasharray="565.48"></circle>
            <text id="timeText" x="50%" y="50%" text-anchor="middle" dy=".3em" font-size="36px" font-weight="bold" fill="#333">00:00</text>
        </svg>

        <div class="actions">
            <button onclick="cancelWaitlist()">Cancel Waitlist</button>
            <button onclick="checkMenu()">Check Menu</button>
            <button onclick="backTo()">Back to home</button>
        </div>

        <p class="notification-message">
            You will receive a notification on your phone when your table is ready!
        </p>
    </div>
    

    <script>
    const customerName = "{{ name }}";
    const queuePosition = parseInt("{{ position }}");
    const waitTimeRemaining = parseInt("{{ wait_time }}"); // REMAINING SECONDS passed from server

    const startKey = `startTime_${customerName}`;
    const endKey = `endTime_${customerName}`;

    document.getElementById('customerName').textContent = customerName;
    document.getElementById('queuePosition').textContent = queuePosition;

    function startCountdown(remainingSeconds) {
        let countdown = remainingSeconds;
        const timeText = document.getElementById('timeText');
        const displayText = document.getElementById('time');
        const progressCircle = document.getElementById('progressCircle');
        const circleLength = 565.48;

        if (window.countdownInterval) clearInterval(window.countdownInterval);

        window.countdownInterval = setInterval(() => {
            if (countdown <= 0) {
                clearInterval(window.countdownInterval);
                timeText.textContent = "Ready!";
                displayText.textContent = "Ready!";
                progressCircle.style.strokeDashoffset = 0;
                return;
            }

            const minutes = Math.floor(countdown / 60);
            const seconds = countdown % 60;
            const formatted = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            timeText.textContent = formatted;
            displayText.textContent = formatted;

            // Progress ring update
            const progress = countdown / totalDuration;
            progressCircle.style.strokeDashoffset = circleLength * (1 - progress);

            countdown--;
        }, 1000);
    }

    let countdown = waitTimeRemaining;
let totalDuration = waitTimeRemaining;

if (countdown > 0) {
    startCountdown(countdown);
} else {
    document.getElementById('timeText').textContent = "Ready!";
    document.getElementById('time').textContent = "Ready!";
}

    const timeLeft = Math.floor((parseInt(endTime) - now) / 1000);

    if (timeLeft > 0) {
        totalDuration = (parseInt(endTime) - parseInt(startTime)) / 1000;
        startCountdown(timeLeft);
    } else {
        document.getElementById('timeText').textContent = "Ready!";
        document.getElementById('time').textContent = "Ready!";
    }

    function cancelWaitlist() {
        fetch('/cancel_waitlist', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: customerName })
        }).then(response => {
            if (response.ok) {
                localStorage.removeItem(startKey);
                localStorage.removeItem(endKey);
                window.location.href = '/';
            } else {
                alert('Failed to cancel waitlist.');
            }
        }).catch(console.error);
    }

    function checkMenu() {
        window.location.href = '/menu';
    }

    function backTo() {
        fetch('/force_notify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: customerName })
        }).then(() => {
            localStorage.removeItem(startKey);
            localStorage.removeItem(endKey);
            window.location.href = '/';
        }).catch(console.error);
    }
   
</script>

</body>
</html>
